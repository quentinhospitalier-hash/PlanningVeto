<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning V√©t√©rinaire - Gestion des Absences</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Planning V√©to">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            animation: slideDown 0.6s ease-out;
        }

        .header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 35px;
            margin-bottom: 30px;
            animation: fadeInUp 0.6s ease-out;
        }

        .card h2 {
            font-family: 'Poppins', sans-serif;
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .absence-list {
            margin-top: 20px;
        }

        .absence-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            animation: fadeIn 0.4s ease-out;
        }

        .absence-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .absence-info {
            flex: 1;
        }

        .absence-info strong {
            color: #667eea;
            font-size: 1.1rem;
        }

        .absence-info p {
            color: #666;
            margin-top: 4px;
            font-size: 0.9rem;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            animation: fadeInUp 0.6s ease-out;
        }

        .stat-card h3 {
            font-size: 2rem;
            color: #667eea;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }

        .stat-card p {
            color: #666;
            margin-top: 5px;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .alert {
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const PERSONNEL = [
            { nom: 'Anne', initiale: 'A' },
            { nom: 'Carole', initiale: 'C' },
            { nom: 'Elodie', initiale: 'D' },
            { nom: 'Claire', initiale: 'S' },
            { nom: 'Annabelle', initiale: 'L' },
            { nom: 'Lucile', initiale: 'U' },
            { nom: 'Quentin', initiale: 'Q' },
            { nom: 'Estelle', initiale: 'E' },
            { nom: 'Coline', initiale: 'R' },
            { nom: 'J√©r√¥me', initiale: 'J' },
            { nom: 'Micka√´l', initiale: 'H' },
            { nom: 'Guillaume', initiale: 'G' },
            { nom: 'Marie', initiale: 'M' }
        ];

        function PlanningApp() {
            const [absences, setAbsences] = useState([]);
            const [formData, setFormData] = useState({
                initiale: '',
                dateDebut: '',
                periodeDebut: 'Matin',
                dateFin: '',
                periodeFin: 'APM'
            });
            const [message, setMessage] = useState(null);

            useEffect(() => {
                const saved = localStorage.getItem('planning_absences');
                if (saved) {
                    setAbsences(JSON.parse(saved));
                }
            }, []);

            const saveAbsences = (newAbsences) => {
                setAbsences(newAbsences);
                localStorage.setItem('planning_absences', JSON.stringify(newAbsences));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (!formData.initiale || !formData.dateDebut || !formData.dateFin) {
                    setMessage({ type: 'error', text: 'Veuillez remplir tous les champs obligatoires' });
                    return;
                }

                const nouvelleAbsence = {
                    id: Date.now(),
                    dateEnregistrement: new Date().toISOString().split('T')[0],
                    ...formData,
                    nom: PERSONNEL.find(p => p.initiale === formData.initiale)?.nom || formData.initiale
                };

                saveAbsences([...absences, nouvelleAbsence]);
                setFormData({
                    initiale: '',
                    dateDebut: '',
                    periodeDebut: 'Matin',
                    dateFin: '',
                    periodeFin: 'APM'
                });
                setMessage({ type: 'success', text: 'Absence ajout√©e avec succ√®s !' });
                
                setTimeout(() => setMessage(null), 3000);
            };

            const handleDelete = (id) => {
                if (confirm('Supprimer cette absence ?')) {
                    saveAbsences(absences.filter(a => a.id !== id));
                    setMessage({ type: 'success', text: 'Absence supprim√©e' });
                    setTimeout(() => setMessage(null), 3000);
                }
            };

            const exportToExcel = () => {
                const wb = XLSX.utils.book_new();
                
                const wsData = [
                    ['Pr√©nom', 'Date enregistrement', 'D√©but Matin', 'D√©but APM', 'Fin Matin', 'Fin APM'],
                    ...absences.map(a => {
                        // Fonction pour convertir une date en objet Date Excel
                        const toExcelDate = (dateStr) => {
                            if (!dateStr) return '';
                            return new Date(dateStr);
                        };
                        
                        // Fonction pour ajouter/soustraire un jour
                        const addDay = (dateStr) => {
                            const d = new Date(dateStr);
                            d.setDate(d.getDate() + 1);
                            return d.toISOString().split('T')[0];
                        };
                        
                        const subtractDay = (dateStr) => {
                            const d = new Date(dateStr);
                            d.setDate(d.getDate() - 1);
                            return d.toISOString().split('T')[0];
                        };
                        
                        let debutMatin = '';
                        let debutAPM = '';
                        let finMatin = '';
                        let finAPM = '';
                        
                        // Colonne C (D√©but Matin)
                        if (a.periodeDebut === 'Matin') {
                            debutMatin = a.dateDebut;
                        } else {
                            // Si commence APM, inscrire le jour suivant
                            debutMatin = addDay(a.dateDebut);
                        }
                        
                        // Colonne F (Fin APM)
                        if (a.periodeFin === 'APM') {
                            finAPM = a.dateFin;
                        } else {
                            // Si termine Matin, inscrire le jour pr√©c√©dent
                            finAPM = subtractDay(a.dateFin);
                        }
                        
                        // Colonne D (D√©but APM)
                        debutAPM = a.dateDebut;
                        
                        // Colonne E (Fin Matin)
                        finMatin = a.dateFin;
                        
                        // R√àGLE 1 : Si D = F alors C et E vides
                        if (debutAPM === finAPM) {
                            debutMatin = '';
                            finMatin = '';
                        }
                        
                        // R√àGLE 2 : Si E = C alors D et F vides
                        if (finMatin === debutMatin && finMatin !== '') {
                            debutAPM = '';
                            finAPM = '';
                        }
                        
                        return [
                            a.nom,
                            toExcelDate(a.dateEnregistrement || new Date().toISOString().split('T')[0]),
                            debutMatin ? toExcelDate(debutMatin) : '',
                            debutAPM ? toExcelDate(debutAPM) : '',
                            finMatin ? toExcelDate(finMatin) : '',
                            finAPM ? toExcelDate(finAPM) : ''
                        ];
                    })
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // D√©finir le format des colonnes de dates
                const dateFormat = 'dddd d mmmm yyyy'; // Format: "mardi 21 avril 2026"
                
                // Appliquer le format aux colonnes de dates (B, C, D, E, F)
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = 1; R <= range.e.r; R++) { // Commence √† 1 pour sauter l'en-t√™te
                    for (let C = 1; C <= 5; C++) { // Colonnes B √† F (1 √† 5)
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                        if (ws[cellAddress] && ws[cellAddress].v instanceof Date) {
                            ws[cellAddress].t = 'd'; // Type date
                            ws[cellAddress].z = dateFormat;
                        }
                    }
                }
                
                // D√©finir la largeur des colonnes
                ws['!cols'] = [
                    { wch: 15 },  // Pr√©nom
                    { wch: 25 },  // Date enregistrement
                    { wch: 25 },  // D√©but Matin
                    { wch: 25 },  // D√©but APM
                    { wch: 25 },  // Fin Matin
                    { wch: 25 }   // Fin APM
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Exigences');
                
                XLSX.writeFile(wb, 'absences_planning.xlsx');
                setMessage({ type: 'success', text: 'Fichier Excel export√© !' });
                setTimeout(() => setMessage(null), 3000);
            };

            const clearAll = () => {
                if (confirm('Supprimer toutes les absences ?')) {
                    saveAbsences([]);
                    setMessage({ type: 'success', text: 'Toutes les absences ont √©t√© supprim√©es' });
                    setTimeout(() => setMessage(null), 3000);
                }
            };

            return (
                <div className="app-container">
                    <div className="header">
                        <h1>üè• Planning V√©t√©rinaire</h1>
                        <p>Gestion des absences du personnel</p>
                    </div>

                    <div className="stats">
                        <div className="stat-card">
                            <h3>{absences.length}</h3>
                            <p>Absences enregistr√©es</p>
                        </div>
                        <div className="stat-card">
                            <h3>{PERSONNEL.length}</h3>
                            <p>Membres de l'√©quipe</p>
                        </div>
                        <div className="stat-card">
                            <h3>{new Set(absences.map(a => a.initiale)).size}</h3>
                            <p>Personnes concern√©es</p>
                        </div>
                    </div>

                    <div className="card">
                        <h2>‚ûï Ajouter une absence</h2>
                        
                        {message && (
                            <div className={`alert alert-${message.type}`}>
                                {message.text}
                            </div>
                        )}

                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Personnel *</label>
                                <select
                                    value={formData.initiale}
                                    onChange={(e) => setFormData({...formData, initiale: e.target.value})}
                                    required
                                >
                                    <option value="">S√©lectionner une personne</option>
                                    {PERSONNEL.map(p => (
                                        <option key={p.initiale} value={p.initiale}>
                                            {p.nom} ({p.initiale})
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label>Date de d√©but *</label>
                                    <input
                                        type="date"
                                        value={formData.dateDebut}
                                        onChange={(e) => setFormData({...formData, dateDebut: e.target.value})}
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label>P√©riode de d√©but</label>
                                    <select
                                        value={formData.periodeDebut}
                                        onChange={(e) => setFormData({...formData, periodeDebut: e.target.value})}
                                    >
                                        <option value="Matin">Matin</option>
                                        <option value="APM">Apr√®s-midi</option>
                                    </select>
                                </div>
                            </div>

                            <div className="form-row">
                                <div className="form-group">
                                    <label>Date de fin *</label>
                                    <input
                                        type="date"
                                        value={formData.dateFin}
                                        onChange={(e) => setFormData({...formData, dateFin: e.target.value})}
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label>P√©riode de fin</label>
                                    <select
                                        value={formData.periodeFin}
                                        onChange={(e) => setFormData({...formData, periodeFin: e.target.value})}
                                    >
                                        <option value="Matin">Matin</option>
                                        <option value="APM">Apr√®s-midi</option>
                                    </select>
                                </div>
                            </div>

                            <button type="submit" className="btn btn-primary">
                                ‚úì Ajouter l'absence
                            </button>
                        </form>
                    </div>

                    <div className="card">
                        <h2>üìã Liste des absences ({absences.length})</h2>
                        
                        {absences.length > 0 ? (
                            <>
                                <div className="absence-list">
                                    {absences.map(absence => (
                                        <div key={absence.id} className="absence-item">
                                            <div className="absence-info">
                                                <strong>{absence.nom}</strong>
                                                <p>
                                                    Du {new Date(absence.dateDebut).toLocaleDateString('fr-FR')} ({absence.periodeDebut})
                                                    {' '}au {new Date(absence.dateFin).toLocaleDateString('fr-FR')} ({absence.periodeFin})
                                                </p>
                                                <p style={{fontSize: '0.85rem', color: '#999', marginTop: '4px'}}>
                                                    Enregistr√© le {new Date(absence.dateEnregistrement).toLocaleDateString('fr-FR')}
                                                </p>
                                            </div>
                                            <button
                                                className="btn btn-danger"
                                                onClick={() => handleDelete(absence.id)}
                                            >
                                                ‚úï
                                            </button>
                                        </div>
                                    ))}
                                </div>

                                <div className="btn-group">
                                    <button className="btn btn-success" onClick={exportToExcel}>
                                        üì• Exporter vers Excel
                                    </button>
                                    <button className="btn btn-secondary" onClick={clearAll}>
                                        üóëÔ∏è Tout supprimer
                                    </button>
                                </div>
                            </>
                        ) : (
                            <p style={{textAlign: 'center', color: '#999', padding: '40px 0'}}>
                                Aucune absence enregistr√©e pour le moment
                            </p>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<PlanningApp />, document.getElementById('root'));
        
        // Enregistrer le Service Worker pour la PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker enregistr√© avec succ√®s:', registration.scope);
                    })
                    .catch(error => {
                        console.log('√âchec de l\'enregistrement du Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
